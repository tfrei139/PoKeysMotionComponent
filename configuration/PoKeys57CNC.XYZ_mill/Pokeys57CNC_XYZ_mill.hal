#*******************
# LinuxCNC EMC
#*******************

loadrt [KINS]KINEMATICS
loadrt [EMCMOT]EMCMOT base_period_nsec=[EMCMOT]BASE_PERIOD servo_period_nsec=[EMCMOT]SERVO_PERIOD num_joints=[KINS]JOINTS num_spindles=[TRAJ]SPINDLES

#*******************
# PoKeys components
#*******************

loadusr -W PoKeysController
# setp PoKeysController.0.log-level 4 # 0..5 = none, error, warning, info, debug, all
setp PoKeysController.0.device-serial 40760
setp PoKeysController.0.axis.0.step-scale 800.0
setp PoKeysController.0.axis.1.step-scale 800.0
setp PoKeysController.0.axis.2.step-scale 1600.0
setp PoKeysController.0.io.input-pin-number.0 19 # Pin 19 is default for probing
setp PoKeysController.0.io.pwm-pin-number.5 17 # Pin 17 on Channel 5 is 0-10V PWM output
setp PoKeysController.0.internal-state 0

loadrt PoKeysMotionBuffer
setp PoKeysMotionBuffer.0.axis.0.step-scale 800.0
setp PoKeysMotionBuffer.0.axis.1.step-scale 800.0
setp PoKeysMotionBuffer.0.axis.2.step-scale 1600.0

# external output signals
net machine-is-on => PoKeysMotionBuffer.0.machine-is-on
net machine-is-on => PoKeysController.0.machine-is-on

# buffer detects motion
net buffer-in-motion <= PoKeysMotionBuffer.0.in-motion
net buffer-in-motion => PoKeysController.0.buffer-in-motion

# Indicators that motion should happen
net motion-jog-is-active <= motion.jog-is-active
net motion-jog-is-active => PoKeysMotionBuffer.0.motion-jog-is-active 
net motion-in-position <= motion.in-position
net motion-in-position => PoKeysMotionBuffer.0.motion-in-position

#*******************
# E-Stop latch component
#*******************

loadrt estop_latch

net estop-loopout estop-latch.0.ok-out => iocontrol.0.emc-enable-in
net estop-loopin iocontrol.0.user-enable-out => estop-latch.0.ok-in
net estop-reset iocontrol.0.user-request-enable => estop-latch.0.reset
net remote-estop estop-latch.0.fault-in <= PoKeysController.0.machine-estop

#*******************
# Assign RT functions
#*******************

addf motion-command-handler   servo-thread
addf motion-controller        servo-thread
addf PoKeysMotionBuffer.0     servo-thread
addf estop-latch.0            servo-thread

#*******************
# Axis X
#*******************

net x-override-limit <= halui.joint.0.override-limits
net x-override-limit => PoKeysController.0.axis.0.override-limit

net x-pos-cmd      <= joint.0.motor-pos-cmd
net x-pos-cmd      => PoKeysMotionBuffer.0.axis.0.position-command

net x-pos-fb       <= PoKeysController.0.axis.0.position-feedback
net x-pos-fb       => joint.0.motor-pos-fb

net min-x          <=  PoKeysController.0.axis.0.limit-negative
net min-x          =>  joint.0.neg-lim-sw-in
net max-x          <=  PoKeysController.0.axis.0.limit-positive
net max-x          =>  joint.0.pos-lim-sw-in

#*******************
# Axis Y
#*******************

net y-override-limit <= halui.joint.1.override-limits
net y-override-limit => PoKeysController.0.axis.1.override-limit

net y-pos-cmd      <= joint.1.motor-pos-cmd
net y-pos-cmd      => PoKeysMotionBuffer.0.axis.1.position-command

net y-pos-fb       <= PoKeysController.0.axis.1.position-feedback
net y-pos-fb       => joint.1.motor-pos-fb

net min-y          <=  PoKeysController.0.axis.1.limit-negative
net min-y          =>  joint.1.neg-lim-sw-in
net max-y          <=  PoKeysController.0.axis.1.limit-positive
net max-y          =>  joint.1.pos-lim-sw-in

#*******************
# Axis Z
#*******************

net z-override-limit <= halui.joint.2.override-limits
net z-override-limit => PoKeysController.0.axis.2.override-limit

net z-pos-cmd      <= joint.2.motor-pos-cmd
net z-pos-cmd      => PoKeysMotionBuffer.0.axis.2.position-command

net z-pos-fb       <= PoKeysController.0.axis.2.position-feedback
net z-pos-fb       => joint.2.motor-pos-fb

net min-z          <=  PoKeysController.0.axis.2.limit-negative
net max-z          =>  joint.2.pos-lim-sw-in
net max-z          <=  PoKeysController.0.axis.2.limit-positive
net max-z          =>  joint.2.pos-lim-sw-in

#*******************
# SPINDLE
#*******************

loadrt scale count=1
addf scale.0 servo-thread
# 100 % / 1'000 RPM max
setp scale.0.gain 0.1

net spindle-speed-scale <= spindle.0.speed-out-abs
net spindle-speed-scale => scale.0.in
net spindle-speed-pwm <= scale.0.out
net spindle-speed-pwm => PoKeysController.0.io.pwm-pin.5

net spindle-enable <= spindle.0.on
net spindle-enable => PoKeysController.0.io.solid-state-relay.0

#*******************
# Probe
#*******************
net probe-in     <=  PoKeysController.0.io.input-pin.0
net probe-in     =>  motion.probe-input

#******************************
# connect miscellaneous signals
#******************************

#  ---HALUI signals---

net axis-select-x =>	halui.axis.x.select
net axis-select-x =>	halui.joint.0.select

net axis-select-y =>	halui.axis.y.select
net axis-select-y =>	halui.joint.1.select

net axis-select-z =>	halui.axis.z.select
net axis-select-z =>	halui.joint.2.select

net axis-select-a =>	halui.axis.a.select
net axis-select-b =>	halui.axis.b.select
net axis-select-c =>	halui.axis.c.select

net axis-selected-x 	<=	halui.axis.x.is-selected
net axis-selected-y 	<=	halui.axis.y.is-selected
net axis-selected-z 	<=	halui.axis.z.is-selected
#net axis-selected-a 	<=	halui.axis.a.is-selected
#net axis-selected-b 	<=	halui.axis.b.is-selected
#net axis-selected-c 	<=	halui.axis.c.is-selected

net jog-selected-pos      halui.axis.selected.plus
net jog-selected-pos      halui.joint.selected.plus
net jog-selected-neg      halui.axis.selected.minus
net jog-selected-neg      halui.joint.selected.minus

net jog-x-enable =>	axis.x.jog-enable
net jog-x-enable =>	joint.0.jog-enable

net jog-y-enable =>	axis.y.jog-enable
net jog-y-enable =>	joint.1.jog-enable

net jog-z-enable =>	axis.z.jog-enable
net jog-z-enable =>	joint.2.jog-enable

net jog-a-enable =>	axis.a.jog-enable
net jog-b-enable =>	axis.b.jog-enable
net jog-c-enable =>	axis.c.jog-enable

net jog-x-pos      halui.axis.x.plus
net jog-x-neg      halui.axis.x.minus
net joginc-x 	halui.axis.x.increment
net joginc-x-pos 	halui.axis.x.increment-plus
net joginc-x-neg 	halui.axis.x.increment-minus

net jog-x-analog   halui.axis.x.analog
net x-is-homed     halui.joint.0.is-homed

net jog-y-pos      halui.axis.y.plus
net jog-y-pos      halui.joint.1.plus
net joginc-y 	halui.axis.y.increment
net joginc-y-pos 	halui.axis.y.increment-plus
net joginc-y-neg 	halui.axis.y.increment-minus
net jog-y-neg      halui.axis.y.minus
net jog-y-neg      halui.joint.1.minus
net joginc-y-pos 	halui.joint.1.increment-plus
net joginc-y-neg 	halui.joint.1.increment-minus
net jog-y-analog   halui.axis.y.analog
net y-is-homed     halui.joint.1.is-homed

net jog-z-pos      halui.axis.z.plus
net jog-z-neg      halui.axis.z.minus
net joginc-z	halui.axis.z.increment
net joginc-z-pos	halui.axis.z.increment-plus
net joginc-z-neg 	halui.axis.z.increment-minus
net jog-z-pos      halui.joint.2.plus
net jog-z-neg      halui.joint.2.minus
net joginc-z-pos 	halui.joint.2.increment-plus
net joginc-z-neg 	halui.joint.2.increment-minus

net jog-z-analog   halui.axis.z.analog
net z-is-homed     halui.joint.2.is-homed

#net mpg-counts  <= pokeys.0.encoder.0.count
net mpg-counts => axis.x.jog-counts
net mpg-counts => joint.0.jog-counts

net mpg-counts => axis.y.jog-counts
net mpg-counts => joint.1.jog-counts

net mpg-counts => axis.z.jog-counts
net mpg-counts => joint.2.jog-counts

# net mpg-scale <= pokeys.0.encoder.0.scale
net mpg-scale-x => axis.x.jog-scale
net mpg-scale-x => joint.0.jog-scale

net mpg-scale-y => axis.y.jog-scale
net mpg-scale-y => joint.1.jog-scale

net mpg-scale-z => axis.z.jog-scale
net mpg-scale-z => joint.2.jog-scale

net joginc-x =>	halui.axis.x.increment
net joginc-x =>	halui.joint.0.increment

net joginc-y =>	halui.axis.y.increment
net joginc-y =>	halui.joint.1.increment

net joginc-z =>	halui.axis.z.increment
net joginc-z =>	halui.joint.2.increment

net joginc-a =>	halui.axis.a.increment
net joginc-b =>	halui.axis.b.increment
net joginc-c =>	halui.axis.c.increment

net machine-is-on         halui.machine.is-on
net jog-speed             halui.axis.jog-speed
net jog-speed             halui.joint.jog-speed
net MDI-mode              halui.mode.is-mdi

#  ---manual tool change signals---

loadusr -W hal_manualtoolchange
net tool-change-request     iocontrol.0.tool-change       =>  hal_manualtoolchange.change
net tool-change-confirmed   iocontrol.0.tool-changed      <=  hal_manualtoolchange.changed
net tool-number             iocontrol.0.tool-prep-number  =>  hal_manualtoolchange.number
net tool-prepare-loopback   iocontrol.0.tool-prepare      =>  iocontrol.0.tool-prepared

